<%- @servers.each do |s| %>
server {

        <%- if  s[:ip].nil? || s[:ip].empty? %>
            <%- if s[:ssl] == true %> 
        listen <%= s[:port] %> ssl;
            <%- else %>
        listen <%= s[:port] %>;
            <%- end %>
        <%- else %>
            <%- if s[:ssl] == true %> 
        listen <%= "#{s[:ip]}:#{s[:port]}" %> ssl;
            <%- else %>
        listen <%= "#{s[:ip]}:#{s[:port]}" %>;
            <%- end %>
        <%- end %>
        
        server_name  <%= s[:server_name] %> <%= s[:server_alias].join(' ') %>;

        <%- unless  @root.nil? || @root.empty? %>
        root <%= @root %>;
        <%- end %>

        <%- @error_page.each do |page| %>
        error_page <%= page[:code] %> <%= page[:handler] %>;
        <%- end %>

        <%- unless  @static.nil? || @static.empty? %>
            <%- @static.each do |item| %>
        location <%= item[:location] %> {
            root <%= item[:root] %>;
        }
            <%- end %>
        <%- end %>

        <%- if s[:ssl] == true %>
        include <%= s[:ssl_include_path] %>;
        <%- end %>

        <%- if s[:redirect].nil? || s[:redirect].empty? %>
        location <%= s[:location] %> {
            include fastcgi_params;
            fastcgi_pass  unix:<%= @socket %>;
        <%- if s[:ssl] == true %>
            fastcgi_param  HTTPS on;
        <%- end %>
        <%- @fastcgi_param.each do |f| %>
            fastcgi_param <%= f[:name] %> <%= f[:value] %>;
        <%- end %>
        <%- if @fastcgi_intercept_errors == true %>
            fastcgi_intercept_errors on;
        <%- end %>
        
        }
        <%- else %>
        rewrite  ^ <%= s[:redirect] %>://$server_name$request_uri? permanent;
        <%- end %>
        access_log /var/log/nginx/<%= @site_name %>.access.log;
        error_log  /var/log/nginx/<%= @site_name %>.error.log;

}
<%- end %>

